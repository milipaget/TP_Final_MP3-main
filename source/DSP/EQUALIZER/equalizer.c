/***************************************************************************//**
  @file     App.c
  @brief    Application functions
  @author   TEAM OREO
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

//#include <DSP/EQUALIZER/FilterCoefficient.h>
#include <stdio.h>
#include <stdbool.h>

#include "stdlib.h"
#include "math.h"
//#include "board.h"
#include <arm_math.h>
#include <DSP/EQUALIZER/equalizer.h>

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/
/* Length of the overall data in the test */
#define TESTLENGTH 4096

/* Block size for the underlying processing */
#define BLOCKSIZE TESTLENGTH

/* Number of 2nd order Biquad stages per filter */
#define NUMSTAGES 	  2
#define BIQUAD_COEFFS 5//6
#define BIQUAD_STATES 4
#define NUMBANDS	  5
#define BAND_FILTERS  7
#define POSTSHIFT     2//3?

#define MIN(x, y) ((x) < (y) ? (x) : (y))

/*******************************************************************************
 * GLOBAL VARIABLES
 ******************************************************************************/

float dummydata = 0;
float z = 0;

/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/

static q31_t biquadStateBandQ15[NUMBANDS][BIQUAD_STATES * NUMSTAGES];
static arm_biquad_casd_df1_inst_q31 S[5];

const q31_t coeffTable[] = {

		534450857,	-1065442920,	531032490,	1066965440,	-530169696,	537608192,	-1073741824,	536141024,	1072193920,	-535326976,
		535086624,	-1066318144,	531275424,	1067693184,	-530888576,	537539712,	-1073566208,	536033312,	1072173504,	-535307104,
		535950048,	-1067610496,	531708448,	1068362880,	-531550880,	537235328,	-1072932928,	535703808,	1072172416,	-535306560,
		536870912,	0,				0,			0,			0,			536870912,	0,				0,			0,			0,
		563848917,	-1122048679,	558261597,	1069444800,	-532622016,	511724832,	-1021953728,	510233760,	1072205120,	-535340416,
		592278071,	-1177883346,	585678382,	1069873856,	-533046976,	487663776,	-973902976,		486243296,	1072230528,	-535366400,
		622257014,	-1236659892,	614490002,	1070267392,	-533437056,	464660768,	-927981824,		463324480,	1072269312,	-535405792,
		529418976,	-1044849792,	516060448,	1046376000,	-510676384,	537650176,	-1069360832,	531827552,	1067552256,	-530744192,
		531849088,	-1048085120,	516921184,	1049275520,	-513439104,	537460736,	-1068837248,	531484224,	1067465536,	-530665984,
		534338592,	-1051281600,	517693920,	1051944000,	-515994464,	537189696,	-1068204480,	531113280,	1067454656,	-530664032,
		536870912,	0,				0,			0,			0,			536870912,	0,				0,			0,			0,
		565411161,	-1107865717,	543424935,	1056263808,	-520147360,	511883552,	-1017772544,	505965568,	1067570560,	-530798080,
		595746316,	-1164343273,	569744824,	1057981376,	-521802048,	487846432,	-969989696,		482208096,	1067664256,	-530900928,
		627987350,	-1223964362,	597347109,	1059556800,	-523324320,	464760704,	-924163200,		459456928,	1067810880,	-531056704,
		499189136,	-941153142,		450992320,	1048827648,	-512930848,	549443136,	-1073741824,	526153728,	959920896,	-440243168,
		507395752,	-950637587,		453140116,	1048391488,	-512626368,	549681408,	-1073741824,	525770048,	971303936,	-449736864,
		515715058,	-959597170,		454806843,	1048241152,	-512615040,	549812864,	-1073741824,	525493248,	981805440,	-458663104,
		536870912,	0,				0,			0,			0,			536870912,	0,				0,			0,			0,
		573125334,	-1119027973,	547231464,	998962112,	-473464096,	511216928,	-934890560,		436746208,	1048467264,	-513123776,
		773395662,	-1510272723,	738469887,	1005861184,	-479463520,	385141120,	-696795264,		322632800,	1048717952,	-513516800,
		1035264743,	-2022486744,	989100442,	1012196928,	-485035904,	292577056,	-523125408,		239918080,	1049172800,	-514114432,
		313873812,	-561961194,		263413263,	971072832,	-447989632,	757663040,	-1073741824,	504391072,	575590720,	-248040432,
		349907072,	-626634368,		292399456,	967791232,	-446608352,	725018304,	-994888256,		461420384,	613596352,	-268082784,
		433925152,	-777886528,		361670624,	965398272,	-446246368,	623266176,	-825152512,		377874112,	649446656,	-288466368,
		536870912,	0,				0,			0,			0,			536870912,	0,				0,			0,			0,
		693969209,	-1247891535,	576826273,	962434752,	-447474496,	442640256,	-535456896,		237835264,	710772352,	-325494368,
		899602739,	-1621670421,	748355151,	961460288,	-448635584,	364021504,	-416044640,		181771616,	736707712,	-341678528,
		1167497228,	-2111727119,	974213067,	961216320,	-450559776,	299221280,	-320801472,		138243616,	760840512,	-357405440,
		221448384,	305239008,		123687848,	-856365440,	-359391776,	666283840,	-526021664,		227639856,	641710336,	-241362640,
		297175776,	421332320,		170793024,	-838936064,	-348701632,	620323648,	-534914304,		218966336,	608620864,	-228711568,
		399411808,	581628928,		236751744,	-820559872,	-338223584,	576965824,	-538319424,		212487072,	573705856,	-217195072,
		536870912,	0,				0,			0,			0,			536870912,	0,				0,			0,			0,
		724621455,	1107520018,		456504652,	-781798784,	-318230784,	497504864,	-531638912,		201269248,	500910176,	-197720784,
		978264344,	1528675107,		635389911,	-761169280,	-308550752,	460671680,	-522238016,		196250048,	462951744,	-189508592,
		1319693151,	2105049039,		883428128,	-740009664,	-299864032,	426652928,	-509969120,		191811616,	423851968,	-183425152
};

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void chEqCoeff(int8_t* bConfig)
{
	for (uint8_t i = 0; i < 5; i++)
	{
		arm_biquad_cascade_df1_init_q31(&S[i], NUMSTAGES,
					(q31_t *) &coeffTable[BAND_FILTERS*BIQUAD_COEFFS*NUMSTAGES*i
					+ BIQUAD_COEFFS*NUMSTAGES*(bConfig[i]/3 + 3)], biquadStateBandQ15[i], POSTSHIFT);
	}
}

void equalizer(q15_t* inputQ15, q15_t* outputQ15, uint16_t samples)
{
	q31_t inputQ31[BLOCKSIZE], outputQ31[BLOCKSIZE];

	/* ----------------------------------------------------------------------
	** Convert block of input data to Q31
	** ------------------------------------------------------------------- */
	arm_q15_to_q31(inputQ15, inputQ31, samples);

	int8_t scaleShift = 1;	// Scale down by 1/4
	arm_scale_q31(inputQ31, 0x7FFFFFFF, -scaleShift, inputQ31, samples);

	/* ----------------------------------------------------------------------
	** Call the Q31 Biquad Cascade DF1 process function for band1, band2, band3, band4, band5
	** ------------------------------------------------------------------- */
	arm_biquad_cascade_df1_q31(&S[0], inputQ31, outputQ31, BLOCKSIZE);
	arm_biquad_cascade_df1_q31(&S[1], outputQ31, outputQ31, BLOCKSIZE);
	arm_biquad_cascade_df1_q31(&S[2], outputQ31, outputQ31, BLOCKSIZE);
	arm_biquad_cascade_df1_q31(&S[3], outputQ31, outputQ31, BLOCKSIZE);
	arm_biquad_cascade_df1_q31(&S[4], outputQ31, outputQ31, BLOCKSIZE);

	/* ----------------------------------------------------------------------
	** Convert Q31 result back to Q15
	** ------------------------------------------------------------------- */
	arm_q31_to_q15(outputQ31, outputQ15, samples);

	//arm_scale_q15(outputQ15, 0x7FFF, scaleShift, outputQ15, samples);

}

/*******************************************************************************
 ******************************************************************************/

